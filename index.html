<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEXC Smart Scalping Scanner</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', monospace; background: #0a0e27; color: #fff; min-height: 100vh; padding: 15px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; padding: 20px 0; border-bottom: 2px solid #1e2749; margin-bottom: 20px; }
        h1 { font-size: 32px; color: #00ff88; text-shadow: 0 0 20px rgba(0,255,136,0.5); margin-bottom: 10px; }
        .subtitle { color: #888; font-size: 14px; }
        .mexc-badge { display: inline-block; background: linear-gradient(135deg, #1e90ff 0%, #00bfff 100%); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-top: 10px; }
        
        .scan-config { background: #1e2749; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 2px solid #2a3a6b; }
        .config-row { display: flex; gap: 30px; align-items: center; justify-content: center; flex-wrap: wrap; margin-bottom: 15px; }
        .config-group { display: flex; gap: 10px; align-items: center; flex-direction: column; }
        .config-label { font-size: 13px; color: #888; font-weight: bold; margin-bottom: 8px; }
        .pair-count-selector { display: flex; gap: 8px; }
        .count-option { padding: 10px 20px; background: #0a0e27; border: 2px solid #2a3a6b; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 16px; font-weight: bold; min-width: 60px; text-align: center; }
        .count-option:hover { border-color: #00ff88; }
        .count-option.active { background: #00ff88; color: #0a0e27; border-color: #00ff88; }
        
        .pair-selection { background: linear-gradient(135deg, #1e2749 0%, #2a3a6b 100%); border-radius: 16px; padding: 25px; margin-bottom: 20px; border: 3px solid #00ff88; }
        .pair-header { text-align: center; margin-bottom: 20px; }
        .pair-title { font-size: 28px; font-weight: bold; color: #00ff88; margin-bottom: 10px; }
        .selected-pair { font-size: 48px; font-weight: bold; color: #00ff88; text-shadow: 0 0 30px rgba(0,255,136,0.8); }
        .pair-score { font-size: 24px; color: #00aaff; margin-top: 10px; }
        .pair-type { font-size: 14px; color: #ffaa00; margin-top: 5px; font-weight: bold; }
        
        .pair-metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
        .pair-metric { background: #0a0e27; padding: 15px; border-radius: 12px; text-align: center; border: 2px solid #2a3a6b; }
        .pair-metric.good { border-color: #00ff88; }
        .metric-label { font-size: 12px; color: #888; margin-bottom: 8px; }
        .metric-value { font-size: 20px; font-weight: bold; color: #00ff88; }
        .metric-value.warning { color: #ffaa00; }
        
        .pair-controls { display: flex; gap: 15px; justify-content: center; align-items: center; flex-wrap: wrap; }
        select { padding: 12px 20px; background: #0a0e27; color: #00ff88; border: 2px solid #00ff88; border-radius: 8px; font-size: 16px; font-family: 'Courier New', monospace; cursor: pointer; min-width: 200px; }
        select:focus { outline: none; border-color: #00aaff; }
        
        .control-panel { background: #1e2749; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 2px solid #2a3a6b; }
        .control-row { display: flex; gap: 30px; align-items: center; justify-content: center; flex-wrap: wrap; }
        .control-group { display: flex; gap: 10px; align-items: center; }
        .control-label { font-size: 14px; color: #888; font-weight: bold; }
        .tf-selector { display: flex; gap: 8px; }
        .tf-option { padding: 8px 16px; background: #0a0e27; border: 2px solid #2a3a6b; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: bold; }
        .tf-option:hover { border-color: #00ff88; }
        .tf-option.active { background: #00ff88; color: #0a0e27; border-color: #00ff88; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .checkbox { width: 20px; height: 20px; cursor: pointer; }
        
        .controls { display: flex; gap: 15px; margin-bottom: 20px; justify-content: center; align-items: center; flex-wrap: wrap; }
        button { padding: 12px 24px; background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%); color: #0a0e27; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; font-family: 'Courier New', monospace; transition: all 0.3s; }
        button:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(0,255,136,0.5); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.stop { background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%); color: white; }
        button.secondary { background: linear-gradient(135deg, #00aaff 0%, #0088cc 100%); color: white; }
        
        .status { display: flex; gap: 20px; justify-content: center; align-items: center; padding: 15px; background: #1e2749; border-radius: 12px; margin-bottom: 20px; }
        .status-item { text-align: center; }
        .status-label { font-size: 12px; color: #888; margin-bottom: 5px; }
        .status-value { font-size: 20px; font-weight: bold; color: #00ff88; }
        .countdown { width: 60px; height: 60px; border-radius: 50%; border: 4px solid #00ff88; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: #00ff88; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        .error-message { background: rgba(255,68,68,0.2); border: 2px solid #ff4444; color: #ff4444; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
        .info-message { background: rgba(0,170,255,0.2); border: 2px solid #00aaff; color: #00aaff; padding: 12px; border-radius: 12px; margin-bottom: 20px; text-align: center; font-size: 13px; }
        .loading { text-align: center; padding: 40px; }
        .spinner { width: 50px; height: 50px; border: 4px solid #1e2749; border-top: 4px solid #00ff88; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .tf-section { margin-bottom: 30px; background: #1e2749; border-radius: 16px; padding: 20px; border: 2px solid #2a3a6b; }
        .tf-header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #2a3a6b; }
        .tf-title { font-size: 24px; font-weight: bold; color: #00ff88; margin-bottom: 5px; }
        .tf-subtitle { font-size: 12px; color: #888; }
        .direction-section { margin-bottom: 25px; }
        .direction-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding: 10px; background: #0a0e27; border-radius: 8px; }
        .direction-icon { font-size: 24px; }
        .direction-title { font-size: 18px; font-weight: bold; }
        .direction-title.long { color: #00ff88; }
        .direction-title.short { color: #ff4444; }
        .direction-count { margin-left: auto; font-size: 14px; color: #888; }
        
        .opportunities-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; }
        .opp-card { background: linear-gradient(135deg, #2a3a6b 0%, #1e2749 100%); border-radius: 12px; padding: 15px; position: relative; }
        .opp-card.long { border-left: 4px solid #00ff88; }
        .opp-card.short { border-left: 4px solid #ff4444; }
        .opp-card.new { animation: highlight 2s; border-color: #00ff88; }
        @keyframes highlight { 0%, 100% { box-shadow: 0 0 0px rgba(0,255,136,0); } 50% { box-shadow: 0 0 30px rgba(0,255,136,0.8); } }
        .new-badge { position: absolute; top: 10px; right: 10px; background: #ff4444; color: white; padding: 3px 10px; border-radius: 15px; font-size: 11px; font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        .opp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .opp-symbol { font-size: 20px; font-weight: bold; }
        .opp-symbol.long { color: #00ff88; }
        .opp-symbol.short { color: #ff4444; }
        .opp-score { font-size: 18px; font-weight: bold; color: #00aaff; }
        
        .trend-indicator { background: rgba(0,255,136,0.1); border: 1px solid #00ff88; border-radius: 8px; padding: 8px; margin-bottom: 12px; font-size: 12px; }
        .trend-indicator.bearish { background: rgba(255,68,68,0.1); border-color: #ff4444; }
        .trend-main { font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .trend-main.bullish { color: #00ff88; }
        .trend-main.bearish { color: #ff4444; }
        .trend-bonus { display: inline-block; background: #00ff88; color: #0a0e27; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: bold; margin-left: auto; }
        .trend-bonus.negative { background: #ff4444; color: white; }
        
        .trade-info { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
        .trade-box { background: #0a0e27; padding: 10px; border-radius: 8px; text-align: center; }
        .trade-label { font-size: 10px; color: #888; margin-bottom: 3px; }
        .trade-value { font-size: 14px; font-weight: bold; }
        .trade-value.entry { color: #00aaff; }
        .trade-value.sl { color: #ff4444; }
        .trade-value.tp { color: #00ff88; }
        
        .metrics { display: flex; gap: 8px; justify-content: space-between; }
        .metric-box { background: #0a0e27; padding: 8px; border-radius: 6px; text-align: center; flex: 1; }
        .metric-label { font-size: 9px; color: #888; margin-bottom: 2px; }
        .metric-value { font-size: 13px; font-weight: bold; color: #00ff88; }
        .no-opportunities { text-align: center; padding: 30px; color: #666; font-size: 14px; }
        
        @media (max-width: 768px) {
            .pair-metrics { grid-template-columns: repeat(2, 1fr); }
            .opportunities-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚡ MEXC SMART SCALPING SCANNER</h1>
            <div class="subtitle">Auto Pair Selection | Perpetual Futures | Hybrid Volatility</div>
            <div class="mexc-badge">🔵 MEXC PERPETUAL | MULTI-PROXY</div>
        </div>
        
        <div class="scan-config">
            <div class="config-row">
                <div class="config-group">
                    <div class="config-label">📊 NOMBRE DE PAIRES À SCANNER</div>
                    <div class="pair-count-selector">
                        <div class="count-option" data-count="25">25</div>
                        <div class="count-option active" data-count="50">50</div>
                        <div class="count-option" data-count="100">100</div>
                        <div class="count-option" data-count="150">150</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="pair-selection" id="pairSelection" style="display: none;">
            <div class="pair-header">
                <div class="pair-title">🎯 PAIRE SÉLECTIONNÉE</div>
                <div class="selected-pair" id="selectedPair">---</div>
                <div class="pair-type">⚡ PERPÉTUEL (Levier jusqu'à 125x)</div>
                <div class="pair-score" id="pairScore">Score: 0/100</div>
            </div>
            
            <div class="pair-metrics" id="pairMetrics"></div>
            
            <div class="pair-controls">
                <select id="pairSelector">
                    <option value="">-- Choisir une paire --</option>
                </select>
                <button class="secondary" onclick="rescanPairs()">🔄 Rescan Paires</button>
            </div>
        </div>
        
        <div class="control-panel">
            <div class="control-row">
                <div class="control-group">
                    <span class="control-label">📊 DÉTECTION TENDANCE :</span>
                    <div class="tf-selector">
                        <div class="tf-option" data-trend-tf="5m">5m</div>
                        <div class="tf-option active" data-trend-tf="15m">15m</div>
                        <div class="tf-option" data-trend-tf="1h">1h</div>
                    </div>
                </div>
                <div class="control-group">
                    <label class="checkbox-group">
                        <input type="checkbox" class="checkbox" id="filterCounterTrend" checked>
                        <span>Filtrer contre-tendance</span>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button id="startBtn">🚀 START SCANNER</button>
            <button id="stopBtn" class="stop" style="display: none;">⏸️ STOP</button>
        </div>
        
        <div class="status">
            <div class="status-item"><div class="status-label">SETUPS TOTAL</div><div class="status-value" id="statTotal">0</div></div>
            <div class="status-item"><div class="status-label">LONG</div><div class="status-value" id="statLong" style="color: #00ff88;">0</div></div>
            <div class="status-item"><div class="status-label">SHORT</div><div class="status-value" id="statShort" style="color: #ff4444;">0</div></div>
            <div class="status-item"><div class="status-label">SCANS</div><div class="status-value" id="statScans">0</div></div>
            <div class="countdown" id="countdown">20</div>
        </div>
        
        <div id="infoMessage" style="display: none;" class="info-message"></div>
        <div id="errorMessage" style="display: none;" class="error-message"></div>
        
        <div id="debugPanel" style="display: none; background: #1a1a2e; border: 2px solid #00ff88; border-radius: 12px; padding: 15px; margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div style="font-weight: bold; color: #00ff88;">🔍 DEBUG LOGS</div>
                <button onclick="clearDebugLogs()" style="padding: 5px 10px; font-size: 12px;">Effacer</button>
            </div>
            <div id="debugLogs" style="font-size: 11px; color: #aaa; font-family: monospace; white-space: pre-wrap;"></div>
        </div>
        
        <div id="loading" class="loading" style="display: none;"><div class="spinner"></div><p style="color: #888;" id="loadingText">Initialisation...</p></div>
        <div id="results"></div>
    </div>
    
    <script>
        var PROXIES = [
            {name: 'ThingProxy', url: url => 'https://thingproxy.freeboard.io/fetch/' + url},
            {name: 'AllOrigins', url: url => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url)},
            {name: 'CorsProxy', url: url => 'https://corsproxy.io/?' + encodeURIComponent(url)}
        ];
        var currentProxyIndex = 0;
        var MEXC_SPOT_URL = 'https://api.mexc.com';
        var MEXC_FUTURES_URL = 'https://contract.mexc.com';
        var isScanning = false, scanInterval = null, countdownInterval = null, scanCount = 0;
        var selectedPair = null, allPairs = [];
        var pairCount = 50;
        var currentData = { '1m': {longs:[],shorts:[]}, '3m': {longs:[],shorts:[]}, '5m': {longs:[],shorts:[]} };
        var previousData = { '1m': {longs:[],shorts:[]}, '3m': {longs:[],shorts:[]}, '5m': {longs:[],shorts:[]} };
        var audioContext = null, countdownValue = 20, trendTimeframe = '15m', filterCounterTrend = true;
        var debugEnabled = true;
        
        function debugLog(message, data) {
            if (!debugEnabled) return;
            
            var panel = document.getElementById('debugPanel');
            var logs = document.getElementById('debugLogs');
            
            panel.style.display = 'block';
            
            var timestamp = new Date().toLocaleTimeString();
            var logLine = '[' + timestamp + '] ' + message;
            if (data !== undefined) {
                logLine += ': ' + (typeof data === 'object' ? JSON.stringify(data, null, 2) : data);
            }
            
            logs.textContent += logLine + '\n';
            logs.scrollTop = logs.scrollHeight;
            
            console.log(message, data);
        }
        
        function clearDebugLogs() {
            document.getElementById('debugLogs').textContent = '';
        }
        
        document.getElementById('startBtn').onclick = startScanning;
        document.getElementById('stopBtn').onclick = stopScanning;
        document.getElementById('pairSelector').onchange = function() {
            if (this.value) {
                var pair = allPairs.find(p => p.symbol === this.value);
                if (pair) selectPair(pair);
            }
        };
        
        document.querySelectorAll('.count-option').forEach(btn => {
            btn.onclick = function() {
                document.querySelectorAll('.count-option').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                pairCount = parseInt(this.dataset.count);
            };
        });
        
        document.querySelectorAll('.tf-option').forEach(b => b.onclick = function() {
            document.querySelectorAll('.tf-option').forEach(x => x.classList.remove('active'));
            this.classList.add('active');
            trendTimeframe = this.dataset.trendTf;
        });
        document.getElementById('filterCounterTrend').onchange = function() { filterCounterTrend = this.checked; };
        
        function initAudio() { try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} }
        function playBeep() {
            if (!audioContext) return;
            var osc = audioContext.createOscillator(), gain = audioContext.createGain();
            osc.connect(gain); gain.connect(audioContext.destination);
            osc.frequency.value = 800; osc.type = 'sine';
            gain.gain.setValueAtTime(0.3, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            osc.start(audioContext.currentTime); osc.stop(audioContext.currentTime + 0.2);
        }
        
        function showError(msg) {
            var err = document.getElementById('errorMessage');
            err.textContent = '⚠️ ' + msg; err.style.display = 'block';
            setTimeout(() => err.style.display = 'none', 8000);
        }
        function showInfo(msg) {
            var info = document.getElementById('infoMessage');
            info.textContent = 'ℹ️ ' + msg; info.style.display = 'block';
            setTimeout(() => info.style.display = 'none', 5000);
        }
        
        async function fetchWithFallback(url) {
            for (var i = 0; i < PROXIES.length; i++) {
                var proxyIndex = (currentProxyIndex + i) % PROXIES.length;
                var proxy = PROXIES[proxyIndex];
                
                try {
                    var proxyUrl = proxy.url(url);
                    var res = await fetch(proxyUrl);
                    
                    if (res.ok) {
                        var data = await res.json();
                        if (i > 0) {
                            currentProxyIndex = proxyIndex;
                        }
                        return data;
                    }
                } catch(e) {}
            }
            throw new Error('Tous les proxies ont échoué');
        }
        
        async function startScanning() {
            if (isScanning) return;
            
            initAudio();
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loadingText').textContent = 'Scan de ' + pairCount + ' paires perpétuelles...';
            
            try {
                await scanAndSelectBestPair();
                
                isScanning = true;
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'block';
                
                scan();
                scanInterval = setInterval(scan, 20000);
                
                countdownValue = 20; updateCountdown();
                countdownInterval = setInterval(() => { 
                    countdownValue--; 
                    if (countdownValue < 0) countdownValue = 20; 
                    updateCountdown(); 
                }, 1000);
                
            } catch(error) {
                showError('Erreur initialisation: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function stopScanning() {
            isScanning = false; 
            clearInterval(scanInterval); 
            clearInterval(countdownInterval);
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('countdown').textContent = '⏸️';
        }
        
        function updateCountdown() { document.getElementById('countdown').textContent = countdownValue; }
        
        async function scanAndSelectBestPair() {
            document.getElementById('loadingText').textContent = 'Récupération contrats perpétuels...';
            var tickers = await fetchWithFallback(MEXC_FUTURES_URL + '/api/v1/contract/ticker');
            
            if (!tickers || !tickers.data) {
                throw new Error('Impossible de récupérer les tickers perpétuels');
            }
            
            var perpPairs = tickers.data
                .filter(t => t.symbol && t.contractId && parseFloat(t.volume24 || 0) > 0)
                .sort((a,b) => parseFloat(b.volume24 || 0) - parseFloat(a.volume24 || 0))
                .slice(0, pairCount);
            
            if (perpPairs.length === 0) {
                throw new Error('Aucune paire perpétuelle trouvée');
            }
            
            document.getElementById('loadingText').textContent = '📊 Présélection rapide (' + perpPairs.length + ' paires)...';
            
            var quickScored = [];
            for (var i = 0; i < perpPairs.length; i++) {
                try {
                    var score = await quickScorePair(perpPairs[i]);
                    if (score && score.totalScore > 30) {
                        quickScored.push(score);
                    }
                } catch(e) {}
            }
            
            if (quickScored.length === 0) {
                throw new Error('Aucune paire valide en présélection');
            }
            
            quickScored.sort((a,b) => b.totalScore - a.totalScore);
            var top20 = quickScored.slice(0, Math.min(20, quickScored.length));
            
            document.getElementById('loadingText').textContent = '🔥 Analyse détaillée ATR (Top ' + top20.length + ')...';
            
            var detailedScored = [];
            for (var i = 0; i < top20.length; i++) {
                try {
                    document.getElementById('loadingText').textContent = '🔥 ATR 1h: ' + (i+1) + '/' + top20.length + ' - ' + top20[i].symbol;
                    var detailed = await detailedScorePair(top20[i]);
                    if (detailed) {
                        detailedScored.push(detailed);
                    }
                } catch(e) {
                    console.error('Detailed score error:', top20[i].symbol, e);
                    detailedScored.push(top20[i]);
                }
            }
            
            detailedScored.sort((a,b) => b.totalScore - a.totalScore);
            allPairs = detailedScored;
            
            var selector = document.getElementById('pairSelector');
            selector.innerHTML = '<option value="">-- Choisir une paire --</option>';
            detailedScored.forEach(p => {
                var opt = document.createElement('option');
                opt.value = p.symbol;
                opt.textContent = p.symbol + ' (Score: ' + p.totalScore + ')';
                selector.appendChild(opt);
            });
            
            selectPair(detailedScored[0]);
            showInfo('✅ Meilleure paire: ' + detailedScored[0].symbol + ' (Score: ' + detailedScored[0].totalScore + '/100)');
            
            document.getElementById('loading').style.display = 'none';
        }
        
        async function quickScorePair(ticker) {
            try {
                var symbol = ticker.symbol;
                var price = parseFloat(ticker.lastPrice || 0);
                if (price === 0) return null;
                
                var scores = {volume: 0, volatility: 0, spread: 0, funding: 0};
                
                var vol24h = parseFloat(ticker.volume24 || 0) * price;
                if (vol24h > 10000000000) scores.volume = 40;
                else if (vol24h > 5000000000) scores.volume = 35;
                else if (vol24h > 1000000000) scores.volume = 30;
                else if (vol24h > 500000000) scores.volume = 25;
                else if (vol24h > 100000000) scores.volume = 20;
                else if (vol24h > 50000000) scores.volume = 15;
                else if (vol24h > 10000000) scores.volume = 10;
                else scores.volume = 5;
                
                var priceChange = parseFloat(ticker.riseFallRate || 0) * 100;
                if (Math.abs(priceChange) > 5) scores.volatility = 30;
                else if (Math.abs(priceChange) > 3) scores.volatility = 25;
                else if (Math.abs(priceChange) > 2) scores.volatility = 20;
                else if (Math.abs(priceChange) > 1) scores.volatility = 15;
                else scores.volatility = 10;
                
                scores.spread = 15;
                
                var fundingRate = parseFloat(ticker.fundingRate || 0) * 100;
                if (Math.abs(fundingRate) < 0.01) scores.funding = 10;
                else if (Math.abs(fundingRate) < 0.05) scores.funding = 5;
                else scores.funding = 0;
                
                return {
                    symbol: symbol,
                    contractId: ticker.contractId,
                    totalScore: scores.volume + scores.volatility + scores.spread + scores.funding,
                    volume24h: vol24h,
                    volatility: Math.abs(priceChange),
                    spread: 0.03,
                    funding: fundingRate,
                    price: price,
                    ticker: ticker
                };
            } catch(e) {
                return null;
            }
        }
        
        async function detailedScorePair(pairData) {
            try {
                var klines = await fetchWithFallback(MEXC_FUTURES_URL + '/api/v1/contract/kline/' + pairData.symbol + '?interval=Min60&limit=24');
                
                if (!klines || !klines.data || klines.data.length < 20) {
                    return pairData;
                }
                
                var closes = klines.data.map(k => parseFloat(k.close));
                var highs = klines.data.map(k => parseFloat(k.high));
                var lows = klines.data.map(k => parseFloat(k.low));
                
                var atr = calculateATR(highs, lows, closes, 14);
                var price = closes[closes.length - 1];
                var volatility1h = (atr / price) * 100;
                
                var volScore = 0;
                if (volatility1h > 1.5) volScore = 30;
                else if (volatility1h > 1.0) volScore = 25;
                else if (volatility1h > 0.7) volScore = 20;
                else if (volatility1h > 0.5) volScore = 15;
                else if (volatility1h > 0.3) volScore = 10;
                else volScore = 5;
                
                var baseScore = pairData.totalScore - 30;
                var newScore = baseScore + volScore + 15 + 10;
                
                return {
                    symbol: pairData.symbol,
                    contractId: pairData.contractId,
                    totalScore: newScore,
                    volume24h: pairData.volume24h,
                    volatility: volatility1h,
                    spread: pairData.spread,
                    funding: pairData.funding,
                    price: price,
                    ticker: pairData.ticker
                };
            } catch(e) {
                return pairData;
            }
        }
        
        function selectPair(pair) {
            selectedPair = pair;
            document.getElementById('pairSelection').style.display = 'block';
            document.getElementById('selectedPair').textContent = pair.symbol;
            document.getElementById('pairScore').textContent = 'Score: ' + pair.totalScore + '/100';
            
            var metricsHtml = '';
            metricsHtml += '<div class="pair-metric ' + (pair.volume24h > 1000000000 ? 'good' : '') + '">';
            metricsHtml += '<div class="metric-label">VOLUME 24H</div>';
            metricsHtml += '<div class="metric-value">$' + (pair.volume24h / 1000000000).toFixed(2) + 'B</div>';
            metricsHtml += '</div>';
            
            metricsHtml += '<div class="pair-metric ' + (pair.volatility > 0.7 ? 'good' : '') + '">';
            metricsHtml += '<div class="metric-label">VOLATILITÉ ATR 1H</div>';
            metricsHtml += '<div class="metric-value">' + pair.volatility.toFixed(2) + '%</div>';
            metricsHtml += '</div>';
            
            metricsHtml += '<div class="pair-metric good">';
            metricsHtml += '<div class="metric-label">SPREAD</div>';
            metricsHtml += '<div class="metric-value">' + pair.spread.toFixed(3) + '%</div>';
            metricsHtml += '</div>';
            
            var fundingClass = Math.abs(pair.funding) < 0.01 ? 'good' : '';
            metricsHtml += '<div class="pair-metric ' + fundingClass + '">';
            metricsHtml += '<div class="metric-label">FUNDING RATE</div>';
            metricsHtml += '<div class="metric-value ' + (Math.abs(pair.funding) > 0.01 ? 'warning' : '') + '">' + (pair.funding > 0 ? '+' : '') + pair.funding.toFixed(3) + '%</div>';
            metricsHtml += '</div>';
            
            document.getElementById('pairMetrics').innerHTML = metricsHtml;
            document.getElementById('pairSelector').value = pair.symbol;
        }
        
        async function rescanPairs() {
            if (isScanning) {
                showError('Arrêtez le scanner avant de rescanner');
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            try {
                await scanAndSelectBestPair();
            } catch(error) {
                showError('Erreur rescan: ' + error.message);
            }
            document.getElementById('loading').style.display = 'none';
        }
        
        async function scan() {
            if (!selectedPair) return;
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loadingText').textContent = 'Scan ' + selectedPair.symbol + '...';
            
            debugLog('=== DÉBUT SCAN ===');
            debugLog('Paire', selectedPair.symbol);
            
            try {
                var ticker = selectedPair.ticker;
                debugLog('Ticker lastPrice', ticker.lastPrice);
                
                var trendData = await getTrendData(selectedPair.symbol, trendTimeframe);
                debugLog('Trend', trendData ? trendData.trend : 'null');
                
                var newData = { '1m': {longs:[],shorts:[]}, '3m': {longs:[],shorts:[]}, '5m': {longs:[],shorts:[]} };
                
                for (var tf of ['1m','3m','5m']) {
                    try {
                        debugLog('Analyse ' + tf);
                        var analysis = await analyzeSymbol(selectedPair.symbol, ticker, tf, trendData);
                        
                        if (analysis && analysis.totalScore >= 100) {
                            newData[tf][analysis.direction === 'LONG' ? 'longs' : 'shorts'].push(analysis);
                            debugLog('✅ Setup ' + tf, analysis.direction + ' Score:' + analysis.totalScore);
                        } else if (analysis) {
                            debugLog('⚠️ Score faible ' + tf, 'Score:' + analysis.totalScore + ' < 100');
                        } else {
                            debugLog('❌ Pas de setup ' + tf);
                        }
                    } catch(e) {
                        debugLog('Erreur ' + tf, e.message);
                    }
                }
                
                var totalSetups = 0;
                for (var tf in newData) {
                    totalSetups += newData[tf].longs.length + newData[tf].shorts.length;
                }
                debugLog('Total setups', totalSetups);
                
                if (totalSetups === 0) {
                    showInfo('Aucun setup détecté (score min: 100). Prochain scan dans 20s...');
                }
                
                for (var tf in newData) {
                    newData[tf].longs.sort((a,b) => b.totalScore - a.totalScore).splice(5);
                    newData[tf].shorts.sort((a,b) => b.totalScore - a.totalScore).splice(5);
                }
                
                previousData = currentData; 
                currentData = newData;
                scanCount++; 
                displayResults();
                
                var hasHigh = Object.values(currentData).some(d => [...d.longs,...d.shorts].some(o => o.totalScore >= 130));
                if (hasHigh && scanCount > 1) playBeep();
                
            } catch(error) { 
                debugLog('ERREUR GLOBALE', error.message);
                showError('Erreur scan: ' + error.message); 
            }
            finally { 
                document.getElementById('loading').style.display = 'none'; 
            }
        }
        
        async function getTrendData(symbol, tf) {
            try {
                var intervalMap = {'5m':'Min5','15m':'Min15','1h':'Min60'};
                var interval = intervalMap[tf];
                var klines = await fetchWithFallback(MEXC_FUTURES_URL + '/api/v1/contract/kline/' + symbol + '?interval=' + interval + '&limit=150');
                
                if (!klines || !klines.data || klines.data.length < 100) return null;
                
                var closes = klines.data.map(k => parseFloat(k.close));
                var ema20 = calculateEMA(closes, 20), ema50 = calculateEMA(closes, 50), ema100 = calculateEMA(closes, 100);
                var price = closes[closes.length-1];
                
                var trend = 'NEUTRAL', strength = 'NONE', bonus = 0;
                if (ema20 > ema50 && ema50 > ema100 && price > ema20) { trend = 'BULLISH'; strength = 'STRONG'; bonus = 25; }
                else if (ema20 > ema50 && price > ema20) { trend = 'BULLISH'; strength = 'MODERATE'; bonus = 15; }
                else if (ema20 < ema50 && ema50 < ema100 && price < ema20) { trend = 'BEARISH'; strength = 'STRONG'; bonus = 25; }
                else if (ema20 < ema50 && price < ema20) { trend = 'BEARISH'; strength = 'MODERATE'; bonus = 15; }
                
                return {trend, strength, bonus, ema20, ema50, ema100};
            } catch(e) { return null; }
        }
        
        async function analyzeSymbol(symbol, ticker, tf, trendData) {
            var intervalMap = {'1m':'Min1','3m':'Min3','5m':'Min5'};
            var interval = intervalMap[tf];
            var klines = await fetchWithFallback(MEXC_FUTURES_URL + '/api/v1/contract/kline/' + symbol + '?interval=' + interval + '&limit=100');
            
            if (!klines || !klines.data || klines.data.length < 50) return null;
            
            var ohlcv = klines.data.map(k => ({
                open:parseFloat(k.open),
                high:parseFloat(k.high),
                low:parseFloat(k.low),
                close:parseFloat(k.close),
                volume:parseFloat(k.volume)
            }));
            return analyzeTimeframe(symbol, ohlcv, ticker, tf, trendData);
        }
        
        function analyzeTimeframe(symbol, ohlcv, ticker, tf, trendData) {
            var closes = ohlcv.map(c => c.close), volumes = ohlcv.map(c => c.volume);
            var highs = ohlcv.map(c => c.high), lows = ohlcv.map(c => c.low);
            var price = closes[closes.length-1], price5ago = closes[closes.length-6];
            var momentum = ((price - price5ago) / price5ago) * 100;
            var avgVol = volumes.slice(-20).reduce((a,b) => a+b, 0) / 20;
            var recentVol = volumes.slice(-3).reduce((a,b) => a+b, 0) / 3;
            var volSpike = avgVol > 0 ? recentVol / avgVol : 1;
            var rsi = calculateRSI(closes, 14);
            var atr = calculateATR(highs, lows, closes, 14);
            var vol = atr / price;
            
            var scores = {momentum:0, volume:0, liquidity:0, microSR:0, rsi:0, volatility:0, trend:0};
            var signals = [];
            
            if (Math.abs(momentum) > 0.3) { scores.momentum = 40; signals.push('Strong momentum'); }
            else if (Math.abs(momentum) > 0.2) scores.momentum = 30;
            else if (Math.abs(momentum) > 0.1) scores.momentum = 20;
            else if (Math.abs(momentum) > 0.05) scores.momentum = 10;
            
            if (volSpike > 3) { scores.volume = 30; signals.push('Volume spike'); }
            else if (volSpike > 2) scores.volume = 20;
            else if (volSpike > 1.5) scores.volume = 10;
            
            var vol24h = selectedPair.volume24h;
            if (vol24h > 50000000) scores.liquidity = 20;
            else if (vol24h > 20000000) scores.liquidity = 15;
            else if (vol24h > 10000000) scores.liquidity = 10;
            
            var support = Math.min(...lows.slice(-20)), resistance = Math.max(...highs.slice(-20));
            var distS = ((price - support) / support) * 100, distR = ((resistance - price) / price) * 100;
            var minDist = Math.min(distS, distR);
            if (minDist < 0.3) { scores.microSR = 20; signals.push('Near key level'); }
            else if (minDist < 0.5) scores.microSR = 15;
            else if (minDist < 1) scores.microSR = 10;
            
            var direction = 'NEUTRAL';
            if (rsi < 20) { scores.rsi = 15; signals.push('RSI extreme oversold'); direction = 'LONG'; }
            else if (rsi < 30) { scores.rsi = 10; signals.push('RSI oversold'); direction = 'LONG'; }
            else if (rsi > 80) { scores.rsi = 15; signals.push('RSI extreme overbought'); direction = 'SHORT'; }
            else if (rsi > 70) { scores.rsi = 10; signals.push('RSI overbought'); direction = 'SHORT'; }
            if (direction === 'NEUTRAL') direction = momentum > 0 ? 'LONG' : 'SHORT';
            
            if (vol > 0.003) { scores.volatility = 15; signals.push('High volatility'); }
            else if (vol > 0.002) scores.volatility = 10;
            else if (vol > 0.001) scores.volatility = 5;
            
            if (trendData) {
                if ((direction === 'LONG' && trendData.trend === 'BULLISH') || (direction === 'SHORT' && trendData.trend === 'BEARISH')) {
                    scores.trend = trendData.bonus; signals.push('With trend');
                } else if ((direction === 'LONG' && trendData.trend === 'BEARISH') || (direction === 'SHORT' && trendData.trend === 'BULLISH')) {
                    if (filterCounterTrend) scores.trend = -30;
                }
            }
            
            var totalScore = Object.values(scores).reduce((a,b) => a+b, 0);
            if (totalScore < 100) return null;
            
            var entry = price;
            var sl = direction === 'LONG' ? entry * 0.997 : entry * 1.003;
            var tp = direction === 'LONG' ? entry * 1.006 : entry * 0.994;
            var rr = Math.abs((tp - entry) / (entry - sl));
            
            return {
                symbol: symbol,
                direction, totalScore: Math.round(totalScore),
                entry: entry.toFixed(6), sl: sl.toFixed(6), tp: tp.toFixed(6), rr: rr.toFixed(1),
                rsi: rsi.toFixed(1), volumeSpike: volSpike.toFixed(1), momentum: momentum.toFixed(2),
                signals, timeframe: tf, trendData, trendBonus: scores.trend
            };
        }
        
        function calculateRSI(prices, period) {
            var changes = prices.slice(1).map((p,i) => p - prices[i]);
            var gains = changes.map(c => c > 0 ? c : 0), losses = changes.map(c => c < 0 ? -c : 0);
            var avgGain = gains.slice(-period).reduce((a,b) => a+b, 0) / period;
            var avgLoss = losses.slice(-period).reduce((a,b) => a+b, 0) / period;
            return avgLoss === 0 ? 100 : 100 - (100 / (1 + avgGain / avgLoss));
        }
        function calculateEMA(prices, period) {
            if (prices.length < period) return 0;
            var k = 2 / (period + 1), ema = prices.slice(0, period).reduce((a,b) => a+b, 0) / period;
            for (var i = period; i < prices.length; i++) ema = prices[i] * k + ema * (1 - k);
            return ema;
        }
        function calculateATR(highs, lows, closes, period) {
            var tr = highs.slice(1).map((h,i) => Math.max(h - lows[i+1], Math.abs(h - closes[i]), Math.abs(lows[i+1] - closes[i])));
            return tr.length < period ? 0 : tr.slice(-period).reduce((a,b) => a+b, 0) / period;
        }
        
        function displayResults() {
            var totalLongs = 0, totalShorts = 0;
            for (var tf in currentData) { totalLongs += currentData[tf].longs.length; totalShorts += currentData[tf].shorts.length; }
            document.getElementById('statTotal').textContent = totalLongs + totalShorts;
            document.getElementById('statLong').textContent = totalLongs;
            document.getElementById('statShort').textContent = totalShorts;
            document.getElementById('statScans').textContent = scanCount;
            
            var pairName = selectedPair ? selectedPair.symbol : '---';
            
            var html = '';
            [{key:'1m',title:'⚡ ULTRA-FAST (1m)',subtitle:'Durée: 2-5 minutes'},
             {key:'3m',title:'🔥 FAST (3m)',subtitle:'Durée: 5-10 minutes'},
             {key:'5m',title:'⏱️ MEDIUM (5m)',subtitle:'Durée: 10-20 minutes'}].forEach(tf => {
                var data = currentData[tf.key];
                html += '<div class="tf-section"><div class="tf-header"><div class="tf-title">' + tf.title + ' - ' + pairName + '</div><div class="tf-subtitle">' + tf.subtitle + ' • Tendance ' + trendTimeframe + '</div></div>';
                
                html += '<div class="direction-section"><div class="direction-header"><div class="direction-icon">🟢</div><div class="direction-title long">LONG SETUPS</div><div class="direction-count">' + data.longs.length + ' opportunités</div></div>';
                if (data.longs.length > 0) {
                    html += '<div class="opportunities-grid">';
                    data.longs.forEach((o,i) => html += renderOppCard(o, i+1, !previousData[tf.key].longs.some(p => p.symbol === o.symbol), 'long'));
                    html += '</div>';
                } else html += '<div class="no-opportunities">Aucun setup LONG (score min: 100)</div>';
                html += '</div>';
                
                html += '<div class="direction-section"><div class="direction-header"><div class="direction-icon">🔴</div><div class="direction-title short">SHORT SETUPS</div><div class="direction-count">' + data.shorts.length + ' opportunités</div></div>';
                if (data.shorts.length > 0) {
                    html += '<div class="opportunities-grid">';
                    data.shorts.forEach((o,i) => html += renderOppCard(o, i+1, !previousData[tf.key].shorts.some(p => p.symbol === o.symbol), 'short'));
                    html += '</div>';
                } else html += '<div class="no-opportunities">Aucun setup SHORT (score min: 100)</div>';
                html += '</div></div>';
            });
            document.getElementById('results').innerHTML = html;
        }
        
        function renderOppCard(o, rank, isNew, dir) {
            var html = '<div class="opp-card ' + dir + (isNew ? ' new' : '') + '">';
            if (isNew) html += '<div class="new-badge">NEW</div>';
            html += '<div class="opp-header"><div class="opp-symbol ' + dir + '">#' + rank + ' ' + o.symbol + '</div><div class="opp-score">' + o.totalScore + '/150</div></div>';
            
            if (o.trendData) {
                var tClass = o.trendData.trend === 'BULLISH' ? 'bullish' : o.trendData.trend === 'BEARISH' ? 'bearish' : 'neutral';
                var tIcon = o.trendData.trend === 'BULLISH' ? '📈' : o.trendData.trend === 'BEARISH' ? '📉' : '➡️';
                var tText = o.trendData.trend === 'BULLISH' ? 'HAUSSIÈRE' : o.trendData.trend === 'BEARISH' ? 'BAISSIÈRE' : 'NEUTRE';
                var tStrength = o.trendData.strength === 'STRONG' ? 'FORTE' : o.trendData.strength === 'MODERATE' ? 'MODÉRÉE' : '';
                html += '<div class="trend-indicator ' + tClass + '"><div class="trend-main ' + tClass + '">' + tIcon + ' Tendance ' + trendTimeframe + ': ' + tText + ' ' + tStrength;
                if (o.trendBonus !== 0) {
                    var bClass = o.trendBonus > 0 ? '' : 'negative';
                    html += '<span class="trend-bonus ' + bClass + '">' + (o.trendBonus > 0 ? '+' : '') + o.trendBonus + ' pts</span>';
                }
                html += '</div></div>';
            }
            
            html += '<div class="trade-info"><div class="trade-box"><div class="trade-label">ENTRY</div><div class="trade-value entry">$' + o.entry + '</div></div>';
            html += '<div class="trade-box"><div class="trade-label">STOP LOSS</div><div class="trade-value sl">$' + o.sl + '</div></div>';
            html += '<div class="trade-box"><div class="trade-label">TAKE PROFIT</div><div class="trade-value tp">$' + o.tp + '</div></div></div>';
            html += '<div class="metrics"><div class="metric-box"><div class="metric-label">R:R</div><div class="metric-value">1:' + o.rr + '</div></div>';
            html += '<div class="metric-box"><div class="metric-label">RSI</div><div class="metric-value">' + o.rsi + '</div></div>';
            html += '<div class="metric-box"><div class="metric-label">VOL</div><div class="metric-value">' + o.volumeSpike + 'x</div></div>';
            html += '<div class="metric-box"><div class="metric-label">MOM</div><div class="metric-value">' + o.momentum + '%</div></div></div></div>';
            return html;
        }
    </script>
</body>
</html>
